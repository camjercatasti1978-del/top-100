<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trading Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0f9ff 100%); min-height: 100vh; }
        .card { background: white; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .price-up { color: #10b981; }
        .price-down { color: #ef4444; }
        @keyframes pulse-glow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        .crypto-row:hover { background: #f1f5f9; cursor: pointer; }
        #loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .position-card { transition: all 0.3s ease; }
        .position-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="text-gray-900 p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <div class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                <div>
                    <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">üìä Crypto Dashboard</h1>
                    <p class="text-gray-600">Trading simul√© avec slippage s√©curis√© (max 3%)</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="connectWallet()" id="wallet-btn" class="px-6 py-3 bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-600 hover:to-pink-600 text-white rounded-lg font-semibold transition-all flex items-center gap-2 shadow-md">
                        <span>ü¶ä</span>
                        <span id="wallet-text">Connecter</span>
                    </button>
                </div>
            </div>
            <div class="mt-4 p-4 bg-blue-50 border-2 border-blue-300 rounded-lg">
                <p class="text-sm text-blue-800 font-bold mb-2">üîí <strong>MODE D√âMO S√âCURIS√â:</strong></p>
                <ul class="text-xs text-blue-700 space-y-1 ml-4">
                    <li>‚Ä¢ Trading SIMUL√â uniquement (aucune transaction r√©elle)</li>
                    <li>‚Ä¢ <strong>Slippage maximum: 3% (protection activ√©e)</strong></li>
                    <li>‚Ä¢ Capital virtuel de $10,000 pour tester vos strat√©gies</li>
                    <li>‚Ä¢ Prix en temps r√©el de Binance</li>
                </ul>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="card rounded-2xl p-6 lg:col-span-2">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">Crypto s√©lectionn√©e</h2>
                    <span id="status" class="pulse-glow">üî¥</span>
                </div>
                <div class="mb-4">
                    <select id="crypto-select" onchange="changeCrypto()" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 text-gray-900">
                        <option value="">Chargement...</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-gray-600 text-sm">Prix actuel</p>
                        <p class="text-3xl font-bold text-gray-900" id="price">$--</p>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Variation 24h</p>
                        <p class="text-2xl font-bold" id="change">--</p>
                    </div>
                </div>
            </div>

            <div class="card rounded-2xl p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-900">üíº Portfolio</h3>
                <div class="space-y-3">
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                        <p class="text-sm text-gray-600">Capital</p>
                        <p class="text-2xl font-bold text-green-600">$<span id="balance">10000</span></p>
                    </div>
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-gray-600">P&L</p>
                        <p class="text-xl font-bold" id="pnl">$0.00</p>
                    </div>
                    <div class="p-3 bg-purple-50 border border-purple-200 rounded-lg">
                        <p class="text-sm text-gray-600">Positions</p>
                        <p class="text-xl font-bold text-gray-900" id="positions">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card rounded-2xl p-6 mb-8">
            <h3 class="text-xl font-bold mb-4 text-gray-900">üí± Trading Simul√©</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-2">Montant ($)</label>
                    <input type="number" id="amount" value="100" min="1" step="1" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-2">Slippage (%) - Max 3%</label>
                    <div class="flex gap-2">
                        <input type="number" id="slippage" value="0.5" min="0.1" max="3" step="0.1" oninput="validateSlippage()" class="flex-1 bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 text-gray-900">
                        <button onclick="setSlippage(0.5)" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold">0.5%</button>
                        <button onclick="setSlippage(1)" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-semibold">1%</button>
                        <button onclick="setSlippage(2)" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-semibold">2%</button>
                        <button onclick="setSlippage(3)" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-semibold">3%</button>
                    </div>
                    <p class="text-xs text-red-600 mt-1 font-semibold">üîí Protection: Max 3%</p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <button onclick="executeTrade('buy')" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-all">üü¢ Acheter</button>
                <button onclick="executeTrade('sell')" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-all">üî¥ Vendre</button>
            </div>
            <div id="trades" class="space-y-2">
                <p class="text-sm text-gray-500">Aucune transaction</p>
            </div>
        </div>

        <div class="card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900">üí∞ Top Cryptomonnaies</h3>
                <button onclick="loadData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">üîÑ</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="border-b-2 border-gray-200">
                        <tr class="text-left text-gray-600">
                            <th class="pb-3 pr-4">#</th>
                            <th class="pb-3 pr-4">Nom</th>
                            <th class="pb-3 pr-4 text-right">Prix</th>
                            <th class="pb-3 text-right">24h %</th>
                        </tr>
                    </thead>
                    <tbody id="table">
                        <tr><td colspan="4" class="py-8 text-center"><div id="loading" class="inline-block text-4xl">‚è≥</div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const MAX_SLIPPAGE = 3;
        const state = {
            list: [],
            selected: null,
            price: 0,
            ws: null,
            balance: 10000,
            initial: 10000,
            positions: [],
            trades: []
        };

        function validateSlippage() {
            const input = document.getElementById('slippage');
            let val = parseFloat(input.value);
            if (isNaN(val) || val < 0.1) input.value = 0.1;
            else if (val > MAX_SLIPPAGE) {
                input.value = MAX_SLIPPAGE;
                alert(`üîí S√©curit√©: Slippage limit√© √† ${MAX_SLIPPAGE}% max`);
            }
        }

        function setSlippage(val) {
            document.getElementById('slippage').value = val;
            document.querySelectorAll('button[onclick^="setSlippage"]').forEach(b => {
                b.className = 'px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-semibold';
            });
            event.target.className = 'px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold';
        }

        function connectWallet() {
            alert('Mode d√©mo - Aucune connexion wallet requise');
        }

        async function loadData() {
            try {
                const res = await fetch('https://api.binance.com/api/v3/ticker/24hr');
                const data = await res.json();
                state.list = data.filter(i => i.symbol.endsWith('USDT'))
                    .map(i => ({
                        symbol: i.symbol,
                        name: i.symbol.replace('USDT', ''),
                        price: parseFloat(i.lastPrice),
                        change: parseFloat(i.priceChangePercent)
                    }))
                    .sort((a, b) => b.price - a.price)
                    .slice(0, 50);
                
                updateSelect();
                updateTable();
                if (state.list.length > 0) {
                    document.getElementById('crypto-select').value = state.list[0].symbol;
                    changeCrypto();
                }
            } catch (e) {
                console.error(e);
            }
        }

        function updateSelect() {
            const sel = document.getElementById('crypto-select');
            sel.innerHTML = state.list.map(c => `<option value="${c.symbol}">${c.name} - $${c.price.toFixed(2)}</option>`).join('');
        }

        function updateTable() {
            const tb = document.getElementById('table');
            tb.innerHTML = state.list.map((c, i) => {
                const cls = c.change >= 0 ? 'price-up' : 'price-down';
                const ico = c.change >= 0 ? '‚ñ≤' : '‚ñº';
                return `<tr class="crypto-row border-b" onclick="selectCrypto('${c.symbol}')">
                    <td class="py-3 pr-4">${i+1}</td>
                    <td class="py-3 pr-4 font-semibold">${c.name}</td>
                    <td class="py-3 pr-4 text-right">$${c.price.toFixed(2)}</td>
                    <td class="py-3 text-right ${cls} font-semibold">${ico} ${Math.abs(c.change).toFixed(2)}%</td>
                </tr>`;
            }).join('');
        }

        function selectCrypto(sym) {
            document.getElementById('crypto-select').value = sym;
            changeCrypto();
        }

        function changeCrypto() {
            const sym = document.getElementById('crypto-select').value;
            if (!sym) return;
            state.selected = state.list.find(c => c.symbol === sym);
            if (state.ws) state.ws.close();
            connectWS();
            updateDisplay();
        }

        function connectWS() {
            const sym = state.selected.symbol.toLowerCase();
            state.ws = new WebSocket(`wss://stream.binance.com:9443/ws/${sym}@ticker`);
            state.ws.onopen = () => document.getElementById('status').textContent = 'üü¢';
            state.ws.onmessage = (e) => {
                const d = JSON.parse(e.data);
                state.price = parseFloat(d.c);
                updateDisplay();
            };
            state.ws.onerror = () => document.getElementById('status').textContent = 'üî¥';
            state.ws.onclose = () => document.getElementById('status').textContent = 'üü°';
        }

        function updateDisplay() {
            if (!state.selected) return;
            document.getElementById('price').textContent = `$${state.price.toFixed(6)}`;
            const chg = state.selected.change;
            const el = document.getElementById('change');
            el.textContent = `${chg >= 0 ? '+' : ''}${chg.toFixed(2)}%`;
            el.className = chg >= 0 ? 'text-2xl font-bold price-up' : 'text-2xl font-bold price-down';
        }

        function executeTrade(type) {
            if (!state.selected || state.price === 0) {
                alert('‚ùå S√©lectionnez une crypto');
                return;
            }

            const slip = parseFloat(document.getElementById('slippage').value);
            if (slip > MAX_SLIPPAGE) {
                alert(`üîí Slippage limit√© √† ${MAX_SLIPPAGE}%`);
                return;
            }

            const amt = parseFloat(document.getElementById('amount').value);
            if (amt <= 0) {
                alert('‚ùå Montant invalide');
                return;
            }

            if (type === 'buy') {
                if (amt > state.balance) {
                    alert('‚ùå Solde insuffisant');
                    return;
                }
                const qty = amt / state.price;
                state.balance -= amt;
                state.positions.push({
                    name: state.selected.name,
                    price: state.price,
                    qty: qty,
                    amt: amt
                });
                state.trades.unshift({
                    type: 'buy',
                    name: state.selected.name,
                    price: state.price,
                    amt: amt,
                    time: new Date().toLocaleTimeString()
                });
                alert(`‚úÖ Achat: ${qty.toFixed(8)} ${state.selected.name}`);
            } else {
                const pos = state.positions.filter(p => p.name === state.selected.name);
                if (pos.length === 0) {
                    alert('‚ùå Aucune position');
                    return;
                }
                const totalVal = pos.reduce((s, p) => s + (p.qty * state.price), 0);
                if (amt > totalVal) {
                    alert('‚ùå Montant trop √©lev√©');
                    return;
                }
                const qty = amt / state.price;
                state.balance += amt;
                let rem = qty;
                state.positions = state.positions.filter(p => {
                    if (p.name === state.selected.name && rem > 0) {
                        if (p.qty <= rem) {
                            rem -= p.qty;
                            return false;
                        } else {
                            p.qty -= rem;
                            rem = 0;
                            return true;
                        }
                    }
                    return true;
                });
                state.trades.unshift({
                    type: 'sell',
                    name: state.selected.name,
                    price: state.price,
                    amt: amt,
                    time: new Date().toLocaleTimeString()
                });
                alert(`‚úÖ Vente: ${qty.toFixed(8)} ${state.selected.name}`);
            }
            updateUI();
        }

        function updateUI() {
            document.getElementById('balance').textContent = state.balance.toFixed(2);
            document.getElementById('positions').textContent = state.positions.length;
            const pnl = state.balance - state.initial;
            const el = document.getElementById('pnl');
            el.textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;
            el.className = pnl >= 0 ? 'text-xl font-bold text-green-600' : 'text-xl font-bold text-red-600';
            
            const tr = document.getElementById('trades');
            if (state.trades.length === 0) {
                tr.innerHTML = '<p class="text-sm text-gray-500">Aucune transaction</p>';
            } else {
                tr.innerHTML = state.trades.slice(0, 5).map(t => `
                    <div class="p-3 bg-gray-50 border rounded-lg">
                        <div class="flex justify-between">
                            <div>
                                <span class="${t.type === 'buy' ? 'text-green-600' : 'text-red-600'} font-semibold">${t.type === 'buy' ? 'üü¢ ACHAT' : 'üî¥ VENTE'}</span>
                                <p class="font-semibold">${t.name}</p>
                                <p class="text-sm text-gray-600">$${t.price.toFixed(6)} - $${t.amt.toFixed(2)}</p>
                            </div>
                            <p class="text-xs text-gray-500">${t.time}</p>
                        </div>
                    </div>
                `).join('');
            }
        }

        window.addEventListener('DOMContentLoaded', loadData);
        window.addEventListener('beforeunload', () => { if (state.ws) state.ws.close(); });
    </script>
</body>
</html>
